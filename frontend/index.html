<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PAPER TRADE â€” Terminal</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #080b0f;
    --surface: #0d1117;
    --surface2: #111820;
    --border: #1e2a38;
    --accent: #00e5ff;
    --green: #00ff88;
    --red: #ff3a5c;
    --yellow: #ffd54f;
    --orange: #ff8c42;
    --text: #c9d8e8;
    --muted: #4a6278;
    --font-mono: 'Space Mono', monospace;
    --font-display: 'Syne', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    height: 50px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .logo {
    font-family: var(--font-display);
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 3px;
    color: var(--accent);
    text-transform: uppercase;
  }

  .logo span { color: var(--muted); }

  .header-stats {
    display: flex;
    gap: 28px;
    align-items: center;
  }

  .stat-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stat-pill .label { color: var(--muted); }
  .stat-pill .value { font-weight: 700; }
  .stat-pill .value.up { color: var(--green); }
  .stat-pill .value.down { color: var(--red); }
  .stat-pill .value.neutral { color: var(--accent); }

  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .btn {
    padding: 6px 14px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn.primary { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,0.05); }

  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  .chart-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .chart-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .page-nav {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .page-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }

  .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
  .page-btn:disabled { opacity: 0.3; cursor: default; }

  .page-info {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .chart-grid {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 2px;
    background: var(--border);
    overflow: hidden;
  }

  .chart-cell {
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  .chart-cell-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 12px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--surface2);
  }

  .cell-symbol {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text);
  }

  .cell-direction {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .cell-direction.long { background: rgba(0,255,136,0.15); color: var(--green); border: 1px solid rgba(0,255,136,0.3); }
  .cell-direction.short { background: rgba(255,58,92,0.15); color: var(--red); border: 1px solid rgba(255,58,92,0.3); }

  .status-badge {
    font-size: 9px;
    padding: 2px 6px;
    letter-spacing: 2px;
    text-transform: uppercase;
    font-weight: 700;
    border: 1px solid;
  }

  .status-badge.open { color: var(--yellow); border-color: rgba(255,213,79,0.4); background: rgba(255,213,79,0.08); }
  .status-badge.success { color: var(--green); border-color: rgba(0,255,136,0.4); background: rgba(0,255,136,0.08); }
  .status-badge.failed { color: var(--red); border-color: rgba(255,58,92,0.4); background: rgba(255,58,92,0.08); }
  .status-badge.partial { color: var(--orange); border-color: rgba(255,140,66,0.4); background: rgba(255,140,66,0.08); }

  .chart-container {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  .chart-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--muted);
    font-size: 11px;
    letter-spacing: 2px;
    gap: 8px;
  }

  .chart-empty .icon { font-size: 28px; opacity: 0.3; }

  .positions-panel {
    width: 300px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }

  .panel-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    flex-shrink: 0;
  }

  .panel-title {
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--accent);
  }

  .panel-subtitle {
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
    letter-spacing: 1px;
  }

  .positions-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .positions-list::-webkit-scrollbar { width: 4px; }
  .positions-list::-webkit-scrollbar-thumb { background: var(--border); }

  .position-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    margin-bottom: 8px;
    padding: 10px 12px;
    cursor: pointer;
    transition: border-color 0.15s;
    position: relative;
    overflow: hidden;
  }

  .position-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
  }

  .position-card.long::before { background: var(--green); }
  .position-card.short::before { background: var(--red); }
  .position-card:hover { border-color: var(--accent); }

  .pos-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
  }

  .pos-symbol { font-size: 12px; font-weight: 700; letter-spacing: 1px; }
  .pos-dir { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
  .pos-dir.long { color: var(--green); }
  .pos-dir.short { color: var(--red); }
  .pos-entry { font-size: 10px; color: var(--muted); }
  .pos-pnl { font-size: 14px; font-weight: 700; letter-spacing: 1px; }
  .pos-pnl.profit { color: var(--green); }
  .pos-pnl.loss { color: var(--red); }
  .pos-pnl.neutral { color: var(--muted); }

  .pos-levels {
    margin-top: 6px;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }

  .level-chip {
    font-size: 9px;
    padding: 2px 5px;
    border: 1px solid;
    letter-spacing: 1px;
  }

  .level-chip.tp { color: var(--green); border-color: rgba(0,255,136,0.2); background: rgba(0,255,136,0.05); }
  .level-chip.sl { color: var(--red); border-color: rgba(255,58,92,0.2); background: rgba(255,58,92,0.05); }

  .pos-actions {
    display: flex;
    gap: 4px;
    margin-top: 8px;
  }

  .pos-btn {
    flex: 1;
    padding: 4px;
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 1px;
    text-transform: uppercase;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
  }

  .pos-btn:hover { color: var(--text); border-color: var(--text); }
  .pos-btn.win:hover { color: var(--green); border-color: var(--green); }
  .pos-btn.lose:hover { color: var(--red); border-color: var(--red); }
  .pos-btn.del:hover { color: var(--red); border-color: var(--red); }

  /* MODALS */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 100;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(6px);
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  .modal.large { width: 850px; }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }

  .modal-title {
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
  }

  .modal-close {
    background: none; border: none; color: var(--muted);
    font-size: 18px; cursor: pointer;
  }

  .modal-body { padding: 20px; }

  .trades-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 12px;
    text-align: center;
  }

  .summary-label { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .summary-value { font-size: 16px; font-weight: 700; }

  .trades-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .trades-table th { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border); color: var(--muted); text-transform: uppercase; }
  .trades-table td { padding: 10px 8px; border-bottom: 1px solid var(--surface2); }

  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 10px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
  .form-control {
    width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-mono); font-size: 12px; outline: none;
  }
  .form-control:focus { border-color: var(--accent); }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .radio-group { display: flex; gap: 8px; }
  .radio-btn {
    flex: 1; padding: 10px; text-align: center; border: 1px solid var(--border);
    background: transparent; color: var(--muted); font-family: var(--font-mono);
    font-size: 11px; text-transform: uppercase; cursor: pointer;
  }
  .radio-btn.active-long { border-color: var(--green); color: var(--green); background: rgba(0,255,136,0.08); }
  .radio-btn.active-short { border-color: var(--red); color: var(--red); background: rgba(255,58,92,0.08); }

  .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }
  .btn-submit { padding: 10px 24px; background: rgba(0,229,255,0.1); border: 1px solid var(--accent); color: var(--accent); font-family: var(--font-mono); font-size: 11px; text-transform: uppercase; cursor: pointer; }

  .toast {
    position: fixed; bottom: 20px; right: 20px; background: var(--surface2); border: 1px solid var(--border);
    padding: 12px 20px; font-size: 12px; z-index: 200; transform: translateY(100px); opacity: 0; transition: all 0.3s;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-color: var(--green); color: var(--green); }
  .toast.error { border-color: var(--red); color: var(--red); }
</style>
</head>
<body>

<div class="header">
  <div class="logo">PAPER<span>TRADE</span></div>
  <div class="header-stats">
    <div class="stat-pill"><span class="label">Trades</span><span class="value neutral" id="stat-total">0</span></div>
    <div class="stat-pill"><span class="label">Wins</span><span class="value up" id="stat-wins">0</span></div>
    <div class="stat-pill"><span class="label">Losses</span><span class="value down" id="stat-losses">0</span></div>
    <div class="stat-pill"><span class="label">Total P&L</span><span class="value" id="stat-pnl">0.00</span></div>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="openPortfolioModal()">ðŸ’¼ Portfolio</button>
    <button class="btn" onclick="openTradesModal()">ðŸ“Š Trades</button>
    <button class="btn primary" onclick="openModal()">+ New Trade</button>
    <button class="btn" onclick="loadAll()">â†» Refresh</button>
  </div>
</div>

<div class="main">
  <div class="chart-area">
    <div class="chart-toolbar">
      <div class="page-nav">
        <button class="page-btn" id="prev-btn" onclick="changePage(-1)">&#8592;</button>
        <span class="page-info" id="page-info">PAGE 1 / 1</span>
        <button class="page-btn" id="next-btn" onclick="changePage(1)">&#8594;</button>
      </div>
      <div style="font-size:10px; color:var(--muted); letter-spacing:2px;">2Ã—2 CHART GRID</div>
    </div>
    <div class="chart-grid" id="chart-grid"></div>
  </div>

  <div class="positions-panel">
    <div class="panel-header">
      <div class="panel-title">Positions</div>
      <div class="panel-subtitle" id="positions-count">0 active</div>
    </div>
    <div class="positions-list" id="positions-list">
      <div class="chart-empty"><div>â—‡</div><div>NO POSITIONS</div></div>
    </div>
  </div>
</div>

<!-- NEW TRADE MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Open Position</span>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Symbol</label>
        <input class="form-control" id="f-symbol" placeholder="e.g. LINK/USDT" />
      </div>
      <div class="form-group">
        <label class="form-label">Direction</label>
        <div class="radio-group">
          <button class="radio-btn active-long" id="btn-long" onclick="setDir('LONG')">â†‘ LONG</button>
          <button class="radio-btn" id="btn-short" onclick="setDir('SHORT')">â†“ SHORT</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Entry Zone</label>
        <div class="form-row">
          <input class="form-control" id="f-entry-low" placeholder="Low" />
          <input class="form-control" id="f-entry-high" placeholder="High" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Take Profits (one per line)</label>
        <textarea class="form-control" id="f-tps" rows="5" placeholder="8.800"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Stop Loss</label>
        <input class="form-control" id="f-sl" placeholder="e.g. 8.144" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn-submit" onclick="submitTrade()">Open Position â†’</button>
    </div>
  </div>
</div>

<!-- TRADES MODAL -->
<div class="modal-overlay" id="trades-modal">
  <div class="modal large">
    <div class="modal-header">
      <span class="modal-title">Trade History</span>
      <button class="modal-close" onclick="closeTradesModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <table class="trades-table">
        <thead>
          <tr><th>Symbol</th><th>Type</th><th>Status</th><th>Entry Zone</th><th>P&L</th><th>Created</th></tr>
        </thead>
        <tbody id="trades-history-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- PORTFOLIO MODAL -->
<div class="modal-overlay" id="portfolio-modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Portfolio Analytics</span>
      <button class="modal-close" onclick="closePortfolioModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="display:flex; flex-direction:column; gap:16px;">
        <div class="summary-box">
          <div class="summary-label">Total Amount of Trades</div>
          <div class="summary-value" id="p-total-count" style="font-size:24px; color:var(--accent)">0</div>
        </div>
        <div class="summary-box">
          <div class="summary-label">Total Portfolio P&L</div>
          <div class="summary-value" id="p-total-pnl" style="font-size:24px;">0.00</div>
        </div>
        <div class="summary-box">
          <div class="summary-label">Win Rate</div>
          <div class="summary-value" id="p-win-rate" style="font-size:24px; color:var(--green)">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@5.0.5/dist/lightweight-charts.standalone.production.js"></script>

<script>
const API = window.location.origin + '/api';
let currentPage = 1, totalPages = 1, allTrades = [], charts = {}, selectedDir = 'LONG', livePriceCache = {};

async function loadAll() { await Promise.all([loadStats(), loadPage(currentPage)]); }

async function loadStats() {
  try {
    const res = await fetch(`${API}/stats`), d = await res.json();
    document.getElementById('stat-total').textContent = d.total;
    document.getElementById('stat-wins').textContent = d.wins;
    document.getElementById('stat-losses').textContent = d.losses;
    const pnlEl = document.getElementById('stat-pnl');
    pnlEl.textContent = (d.total_pnl >= 0 ? '+' : '') + d.total_pnl.toFixed(4);
    pnlEl.className = 'value ' + (d.total_pnl > 0 ? 'up' : d.total_pnl < 0 ? 'down' : 'neutral');
  } catch(e) {}
}

async function loadPage(page) {
  try {
    const res = await fetch(`${API}/trades?page=${page}&per_page=4`), d = await res.json();
    totalPages = d.total_pages; currentPage = d.page; allTrades = d.trades;
    renderGrid(allTrades); await loadAllPositions(); updatePageUI();
  } catch(e) {}
}

async function loadAllPositions() {
  try {
    const res = await fetch(`${API}/trades?per_page=100`), d = await res.json();
    renderPositions(d.trades);
  } catch(e) {}
}

function renderGrid(trades) {
  Object.values(charts).forEach(c => { try { c.chart.remove(); } catch(e) {} });
  charts = {};
  const grid = document.getElementById('chart-grid'); grid.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const trade = trades[i], cell = document.createElement('div');
    cell.className = 'chart-cell';
    if (!trade) {
      cell.innerHTML = `<div class="chart-cell-header"><span class="cell-symbol" style="color:var(--muted)">EMPTY SLOT</span></div><div class="chart-container"><div class="chart-empty"><div>â—‡</div><div>NO TRADE</div></div></div>`;
    } else {
      cell.innerHTML = `<div class="chart-cell-header"><span class="cell-symbol">${trade.symbol}</span><div style="display:flex;gap:6px;align-items:center"><span class="cell-direction ${trade.direction.toLowerCase()}">${trade.direction}</span><span class="status-badge ${trade.status}">${trade.status.toUpperCase()}</span></div></div><div class="chart-container" id="chart-${i}"></div>`;
    }
    grid.appendChild(cell);
    if (trade) setTimeout(() => initChart(i, trade), 50);
  }
}

function initChart(idx, trade) {
  const container = document.getElementById(`chart-${idx}`); if (!container) return;
  const chart = LightweightCharts.createChart(container, {
    layout: { background: { color: '#0d1117' }, textColor: '#4a6278' },
    grid: { vertLines: { color: '#111820' }, horzLines: { color: '#111820' } },
    rightPriceScale: { borderColor: '#1e2a38', scaleMargins: { top: 0.15, bottom: 0.15 } },
    timeScale: { borderColor: '#1e2a38', timeVisible: true },
  });
  const midEntry = (trade.entry_low + trade.entry_high) / 2;
  const candleData = generateMockCandles(midEntry, trade.direction);
  const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, { upColor: '#00ff88', downColor: '#ff3a5c' });
  candleSeries.setData(candleData);
  const timeRange = candleData.map(c => c.time);
  const drawLine = (val, color, style, title) => {
    const s = chart.addSeries(LightweightCharts.LineSeries, { color, lineWidth: 1, lineStyle: style, priceLineVisible: false, lastValueVisible: true, title });
    s.setData(timeRange.map(t => ({ time: t, value: val })));
  };
  drawLine(trade.entry_low, 'rgba(255,213,79,0.5)', LightweightCharts.LineStyle.Dashed, 'Entry');
  drawLine(trade.entry_high, 'rgba(255,213,79,0.5)', LightweightCharts.LineStyle.Dashed, 'Entry');
  trade.take_profits.forEach((tp, i) => drawLine(tp, `rgba(0,255,136,${0.3 + i*0.1})`, LightweightCharts.LineStyle.Dotted, `TP${i+1}`));
  drawLine(trade.stop_loss, 'rgba(255,58,92,0.7)', LightweightCharts.LineStyle.Dashed, 'SL');
  
  const entryTime = Math.floor(new Date(trade.created_at).getTime() / 1000);
  candleSeries.setMarkers([{ time: entryTime, position: 'inBar', color: 'rgba(255, 213, 79, 1)', shape: 'arrowUp', text: 'ENTRY', size: 1 }]);

  chart.timeScale().fitContent();
  charts[idx] = { chart };
}

function generateMockCandles(basePrice, direction) {
  const data = []; let price = basePrice * (direction === 'LONG' ? 0.98 : 1.02);
  const now = Math.floor(Date.now()/1000);
  for (let i = 60; i >= 0; i--) {
    const vol = basePrice * 0.008, open = price, close = price + (Math.random() - 0.48) * vol;
    data.push({ time: now - i*3600, open, high: Math.max(open, close)+vol*0.5, low: Math.min(open, close)-vol*0.5, close });
    price = close;
  }
  return data;
}

function renderPositions(trades) {
  const list = document.getElementById('positions-list');
  const open = trades.filter(t => t.status === 'open').length;
  document.getElementById('positions-count').textContent = `${open} active`;
  if (!trades.length) { list.innerHTML = '<div class="chart-empty"><div>â—‡</div><div>NO POSITIONS</div></div>'; return; }
  
  list.innerHTML = trades.map(t => {
    // Calculate simulated percent profit if trade is open
    let pnlPercent = t.pnl; // If already set in DB
    if (t.status === 'open') {
        const entry = (t.entry_low + t.entry_high) / 2;
        const mockCurrent = entry * (t.direction === 'LONG' ? 1.015 : 0.985); // 1.5% profit mock
        pnlPercent = ((mockCurrent - entry) / entry) * 100 * (t.direction === 'LONG' ? 1 : -1);
    }
    
    const pnlClass = pnlPercent > 0 ? 'profit' : pnlPercent < 0 ? 'loss' : 'neutral';
    const pnlStr = (pnlPercent > 0 ? '+' : '') + pnlPercent.toFixed(2) + '%';

    return `
      <div class="position-card ${t.direction.toLowerCase()} ${t.status}">
        <div class="pos-row"><span class="pos-symbol">${t.symbol}</span><span class="status-badge ${t.status}">${t.status.toUpperCase()}</span></div>
        <div class="pos-row"><span class="pos-dir ${t.direction.toLowerCase()}">${t.direction === 'LONG' ? 'â†‘' : 'â†“'} ${t.direction}</span><span class="pos-pnl ${pnlClass}">${pnlStr}</span></div>
        <div class="pos-entry">Entry: ${t.entry_low} â€“ ${t.entry_high}</div>
        <div class="pos-actions">
          <button class="pos-btn win" onclick="updateStatus(${t.id},'success')">âœ“ Win</button>
          <button class="pos-btn lose" onclick="updateStatus(${t.id},'failed')">âœ— Loss</button>
          <button class="pos-btn del" onclick="deleteTrade(${t.id})">âŒ«</button>
        </div>
      </div>`;
  }).join('');
}

async function updateStatus(id, status) {
  const pnlValue = status === 'success' ? 2.5 : -1.5; // Default mock pnl for status change
  await fetch(`${API}/trades/${id}`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ status, pnl: pnlValue }) });
  showToast(`Trade ${status}`, 'success'); loadAll();
}

async function deleteTrade(id) {
  if (confirm('Delete?')) { await fetch(`${API}/trades/${id}`, { method: 'DELETE' }); loadAll(); }
}

function changePage(dir) { currentPage += dir; loadPage(currentPage); }
function updatePageUI() { document.getElementById('page-info').textContent = `PAGE ${currentPage} / ${totalPages}`; document.getElementById('prev-btn').disabled = currentPage <= 1; document.getElementById('next-btn').disabled = currentPage >= totalPages; }

function openModal() { document.getElementById('modal').classList.add('active'); }
function closeModal() { document.getElementById('modal').classList.remove('active'); }

function openTradesModal() { document.getElementById('trades-modal').classList.add('active'); loadTradesHistory(); }
function closeTradesModal() { document.getElementById('trades-modal').classList.remove('active'); }

function openPortfolioModal() { document.getElementById('portfolio-modal').classList.add('active'); loadPortfolioStats(); }
function closePortfolioModal() { document.getElementById('portfolio-modal').classList.remove('active'); }

async function loadPortfolioStats() {
  try {
    const res = await fetch(`${API}/stats`), d = await res.json();
    document.getElementById('p-total-count').textContent = d.total;
    document.getElementById('p-total-pnl').textContent = (d.total_pnl >= 0 ? '+' : '') + d.total_pnl.toFixed(4) + '%';
    document.getElementById('p-total-pnl').className = 'summary-value ' + (d.total_pnl > 0 ? 'up' : d.total_pnl < 0 ? 'down' : 'neutral');
    const winRate = d.total > 0 ? ((d.wins / d.total) * 100).toFixed(1) : 0;
    document.getElementById('p-win-rate').textContent = winRate + '%';
  } catch(e) {}
}

async function loadTradesHistory() {
  const t = await fetch(`${API}/trades?per_page=100`);
  const data = await t.json();
  document.getElementById('trades-history-body').innerHTML = data.trades.map(x => `<tr><td>${x.symbol}</td><td>${x.direction}</td><td>${x.status}</td><td>${x.entry_low}</td><td>${(x.pnl||0).toFixed(2)}%</td><td>${new Date(x.created_at).toLocaleDateString()}</td></tr>`).join('');
}

function setDir(d) { selectedDir = d; document.getElementById('btn-long').className = d==='LONG'?'radio-btn active-long':'radio-btn'; document.getElementById('btn-short').className = d==='SHORT'?'radio-btn active-short':'radio-btn'; }

async function submitTrade() {
  const symbol = document.getElementById('f-symbol').value, low = parseFloat(document.getElementById('f-entry-low').value), high = parseFloat(document.getElementById('f-entry-high').value), sl = parseFloat(document.getElementById('f-sl').value), tps = document.getElementById('f-tps').value.split('\n').map(v => parseFloat(v));
  const res = await fetch(`${API}/create`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ symbol, direction: selectedDir, entry_low: low, entry_high: high, take_profits: tps, stop_loss: sl }) });
  const d = await res.json(); if (d.success) { closeModal(); loadAll(); }
}

function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast show ${type}`; setTimeout(() => t.className = 'toast', 3000); }

document.getElementById('modal').onclick = e => { if (e.target.id === 'modal') closeModal(); };
document.getElementById('trades-modal').onclick = e => { if (e.target.id === 'trades-modal') closeTradesModal(); };
document.getElementById('portfolio-modal').onclick = e => { if (e.target.id === 'portfolio-modal') closePortfolioModal(); };

loadAll(); setInterval(loadAll, 30000);
</script>
</body>
</html>
